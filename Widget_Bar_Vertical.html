<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CDC2025 ¬∑ Widget Bar Vertical</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f14;
  --text:#f2f5f8;
  --muted:#a7b1bd;
  --accent:#FCA000;
  --accent-2:#104E59;
  --accent-3:#EDD2BC;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  --stage-scale: 1;
  --bar-bg: rgba(11,15,20,0.75);
  --fs: 1;
  --bar-w: 160px;
}

* { box-sizing:border-box; margin:0; padding:0; }
html, body { 
  width:100vw; height:100vh; 
  background: transparent; color:var(--text);
  font-family:var(--font); overflow:hidden;
}

/* Fixed 1920x1080 stage scaled to fit viewport */
.stage { position:absolute; left:50%; top:50%; width:1920px; height:1080px; transform:translate(-50%,-50%) scale(var(--stage-scale)); transform-origin:center; }

/* Vertical bar */
.vbar { position:absolute; top:0; bottom:0; left:0; width:var(--bar-w);
  background:var(--bar-bg); backdrop-filter:blur(8px);
  border-right:1px solid rgba(255,255,255,0.06);
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  padding: 20px 12px; gap: 16px; font-size: calc(14px * var(--fs));
}
.vbar.right { left:auto; right:0; border-right:none; border-left:1px solid rgba(255,255,255,0.06); }

.logo { font-weight:800; font-size: calc(18px * var(--fs)); display:flex; align-items:center; gap:6px; white-space:nowrap; }
.rainbow { background:linear-gradient(90deg,#FFE259,#FFA751); background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.sep { width:100%; height:1px; background:rgba(255,255,255,0.08); margin: 4px 0; }

.goal-global { width:100%; display:flex; flex-direction:column; align-items:center; gap:6px; padding: 8px 10px; background: rgba(252,160,0,0.1); border-radius:8px; border:1px solid rgba(252,160,0,0.2); }
.goal-label { font-weight:700; font-size: calc(11px * var(--fs)); text-transform:uppercase; color:var(--accent); letter-spacing:0.5px; text-align:center; white-space:nowrap; }
.goal-amount { font-weight:800; font-size: calc(18px * var(--fs)); color:#fff; white-space:nowrap; }

.goal-personal { width:100%; min-height: 36px; display:flex; align-items:center; justify-content:center; background:transparent; border:0; color:var(--muted); font-size: calc(12px * var(--fs)); border-radius:8px; }

.stats-compact { width:100%; display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:auto; }
.stat-item { display:flex; align-items:center; gap:6px; font-size: calc(16px * var(--fs)); }
.stat-icon { font-size: calc(18px * var(--fs)); }
.stat-value { font-weight:700; color:#fff; }

.hashtag { color:var(--accent); font-weight:700; font-size: calc(13px * var(--fs)); text-align:center; width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-top: 8px; }

body { font-family:"Outfit", var(--font); }
</style>
</head>
<body>
<div class="stage">
  <div id="vbar" class="vbar">
  <div class="logo"><span class="rainbow">#CDC2025</span></div>
    <div class="sep"></div>
    <div class="goal-global">
      <span class="goal-label">Cagnotte</span>
      <span class="goal-amount" id="global-amount">0 ‚Ç¨</span>
    </div>
    <div class="goal-personal"><!-- slot perso --></div>
    <div class="sep"></div>
    <div class="stats-compact">
  <div class="stat-item"><span class="stat-icon">üë•</span><span class="stat-value" id="viewers-count">0</span><span class="small" id="viewers-label">participants</span></div>
  <div class="stat-item"><span class="stat-icon">üî¥</span><span class="stat-value" id="live-count">0</span><span class="small" id="live-label">en ligne</span></div>
      <div class="stat-item"><span class="stat-icon">‚è±Ô∏è</span><span class="stat-value" id="timer">00:00</span></div>
    </div>
    <div class="hashtag">#ProtectionAnimale</div>
  </div>
</div>
<script>
function fitStage(){ const s=Math.min(window.innerWidth/1920, window.innerHeight/1080); document.documentElement.style.setProperty('--stage-scale', s);} window.addEventListener('resize', fitStage); fitStage();
const url=new URLSearchParams(window.location.search);
const CFG={
  accent:url.get('accent')||null,
  statsUrl:url.get('statsUrl')||'https://createursdecompagnie.github.io/cdc2025-live-stats/out/live_stats.json',
  goalWidgetUrl:url.get('goalWidgetUrl')||'https://createursdecompagnie.github.io/cdc2025-live-stats/cdc_goal_widget.html',
  updateInterval: parseInt(url.get('interval'))||30000,
  side: (url.get('side')||'left').toLowerCase(),
  barW: url.get('barW')||null,
  showCagnotte: url.get('showCagnotte') !== 'false',
  showStats: url.get('showStats') !== 'false',
  showHashtag: url.get('showHashtag') !== 'false',
  barOpacity: parseFloat(url.get('barOpacity')) || 0.75,
};
if (CFG.accent) document.documentElement.style.setProperty('--accent', CFG.accent);
if (url.get('text')) document.documentElement.style.setProperty('--text', url.get('text'));
if (url.get('muted')) document.documentElement.style.setProperty('--muted', url.get('muted'));
if (url.get('barBg')) {
  const barBg = url.get('barBg');
  // Preserve barOpacity if custom barBg is set
  if (!barBg.includes('rgba') && !barBg.includes('rgb')) {
    // Convert hex to rgba with opacity
    const opacity = CFG.barOpacity;
    // Simple hex conversion - if it's a hex color
    if (barBg.startsWith('#')) {
      const hex = barBg.substring(1);
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);
      document.documentElement.style.setProperty('--bar-bg', `rgba(${r},${g},${b},${opacity})`);
    } else {
      document.documentElement.style.setProperty('--bar-bg', barBg);
    }
  } else {
    document.documentElement.style.setProperty('--bar-bg', barBg);
  }
} else if (CFG.barOpacity !== 0.75) {
  // Apply custom opacity to default color
  document.documentElement.style.setProperty('--bar-bg', `rgba(11,15,20,${CFG.barOpacity})`);
}
const fsParam=parseFloat(url.get('fs')||url.get('fontScale')||url.get('fontsize')); if(!isNaN(fsParam)&&fsParam>0.25&&fsParam<=4){ document.documentElement.style.setProperty('--fs', String(fsParam));}
if (CFG.barW) document.documentElement.style.setProperty('--bar-w', CFG.barW+(CFG.barW.endsWith('px')||CFG.barW.endsWith('%')?'':'px'));
const hashtagParam=url.get('hashtag'); if (hashtagParam){ const el=document.querySelector('.hashtag'); if (el) el.textContent=hashtagParam; }
const logoParam=url.get('logo'); if (logoParam){ const span=document.querySelector('.logo .rainbow'); if (span) span.textContent=logoParam; }
// Side placement
const vbar=document.getElementById('vbar'); if (CFG.side==='right') vbar.classList.add('right'); else vbar.classList.remove('right');

function fmt(n){ return new Intl.NumberFormat('fr-FR').format(n); }
function formatCurrentTime(){ const now=new Date(); return `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; }

function applyVisibility(){
  const cagnotteDiv=document.querySelector('.goal-global');
  const statsDiv=document.querySelector('.stats-compact');
  const hashtagDiv=document.querySelector('.hashtag');
  if(cagnotteDiv) cagnotteDiv.style.display=CFG.showCagnotte?'flex':'none';
  if(statsDiv) statsDiv.style.display=CFG.showStats?'flex':'none';
  if(hashtagDiv) hashtagDiv.style.display=CFG.showHashtag?'block':'none';
}

async function updateGlobalGoal(){
  try{
    const configUrl='https://raw.githubusercontent.com/createursdecompagnie/cdc2025-live-stats/main/cagnotte_config.json';
    const res=await fetch(configUrl+'?t='+Date.now());
    if(!res.ok) throw new Error('Config fetch failed: '+res.status);
    const config=await res.json();
    const brut=parseFloat(config.brut)||0;
    const ajouts=parseFloat(config.ajouts)||0;
    const total=brut+ajouts;
    const formatted=new Intl.NumberFormat('fr-FR',{minimumFractionDigits:0,maximumFractionDigits:2}).format(total)+' ‚Ç¨';
    document.getElementById('global-amount').textContent=formatted;
    console.log('‚úÖ Global goal updated:',{brut,ajouts,total});
  }catch(e){console.warn('Global goal fetch failed:',e);document.getElementById('global-amount').textContent='0 ‚Ç¨';}
}

async function updateStats(){
  try{
    const res=await fetch(CFG.statsUrl+'?t='+Date.now()); const data=await res.json();
    if(Array.isArray(data.members)){
      const live=data.members.filter(m=>m.is_live).length;
      const total=data.members.length;
      const viewers=data.members.reduce((sum,m)=>sum+(m.viewer_count||0),0);
      document.getElementById('viewers-count').textContent=fmt(viewers);
      document.getElementById('live-count').textContent=`${live}/${total}`;
    }else{
      if(data.total_viewers!==undefined) document.getElementById('viewers-count').textContent=fmt(data.total_viewers);
      if(data.live_count!==undefined) document.getElementById('live-count').textContent=fmt(data.live_count)+' Live';
    }
  }catch(e){ console.warn('Failed to update stats:', e); }
}

updateGlobalGoal(); updateStats(); applyVisibility(); setInterval(()=>{updateGlobalGoal(); updateStats();}, CFG.updateInterval);
</script>
</body>
</html>
